<!--Team4 Web Teleop Interface-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/ros-websocket/ros-websocket.html">
<link rel="import" href="../bower_components/ros-topic/ros-topic.html"> 
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/ros-service/ros-service.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">    

<dom-module id="auxie-teleop-app">
 	<template>
 		<ros-websocket auto ros="{{ros}}"
			url="{{url}}"
			on-connection="_handleConnection"
			on-close="_handleClose"
			on-error="_handleError"
	    ></ros-websocket>

	    <ros-topic
	        id="baseTopic"
	        ros="{{ros}}"
	        topic="cmd_vel"
	        msg-type="geometry_msgs/Twist"
	    ></ros-topic>

		<ros-service            
			id="commandService"
			on-response="_handleCommandSuccess"
			on-fail="_handleCommandFail"
			name="/web_teleop/command_service"
			ros="{{ros}}"
			service-type="web_teleop/CommandService"
		></ros-service>

 		<div id="interface">
	        <div id="header">
	            <img src="src/auxielogo_sm.jpeg" alt="auxie logo" width="220" height="auto"/>
	            <div id="seperator">
	                <h2>[[status]]</h2>
	            </div>
	        </div>
	        
	        <div id="main_interface">
	            <div id="auto">
	                <h3>Auto Mode <paper-button id="info_btn" on-tap="_showAutoInfo"><img src="src/info.png" alt="get_info" width="20" height="auto" /></paper-button></h3>

	                <div id="auto_info" style="display:none">
	                	<p><b>Grab Fork</b>: Let Auxie fetch the fork.</p>
	                	<p><b>Grab Spoon</b>: Let Auxie fetch the spoon.</p>
	                	<p><b>Feed</b>: Let Auxie feed you!</p>
	                	<p><b>EMERGENCY STOP</b>: STOP AUXIE'S MOVE IMMEDIATELY!!!</p>
	                </div>

	                <div id="feeding">
	                    <paper-button id="grab_fork_btn" on-tap="_grabFork" class="btn">Grab Fork</paper-button>
	                    <paper-button id="grab_spoon_btn" on-tap="_grabSpoon" class="btn">Grab Spoon</paper-button>
	                    <paper-button id="feed_btn" on-tap="_feed" class="btn">Feed</paper-button>
	                </div>
	            </div>
	            
	            <div id="manual">
	                <h3>Manual Mode <paper-button id="info_btn" on-tap="_showManualInfo"><img src="src/info.png" alt="get_info" width="20" height="auto" /></paper-button></h3>
	                
	                <div id="manual_info" style="display:none">
						<p><b>Gripper Position</b>: Set Auxie's gripper position by specifying the gripper's X, Y and Z value with respect to its base. After you've specified all three values, click "Set Gripper Position" and Auxie will move its "hand" to the place you want!</p>
	                	<p><b>Open Gripper</b>: Open Auxie's gripper.</p>
	                	<p><b>Close Gripper</b>: Close Auxie's gripper.</p>
	                	<p><b>EMERGENCY STOP</b>: STOP AUXIE'S MOVE IMMEDIATELY!!!</p>
	                </div>

	                <h4>Gripper Position</h4>
	                <div class="slidecontainer">
	                	<span>X</span>
	                	<paper-slider min="-1.6" max="1.6" step="0.01" editable value="{{desiredGripperX}}"></paper-slider>
	                    <!-- <input type="range" min="1" max="100" value="50" class="slider" id="myRange"> -->
	                </div>
	                <div class="slidecontainer">
	                	<span>Y</span>
	                	<paper-slider min="-1.6" max="1.6" step="0.01" editable value="{{desiredGripperY}}"></paper-slider>
	                    <!-- <input type="range" min="1" max="100" value="50" class="slider" id="myRange"> -->
	                </div>
	                <div class="slidecontainer">
	                	<span>Z</span>
	                	<paper-slider min="-1.6" max="1.6" step="0.01" editable value="{{desiredGripperZ}}"></paper-slider>
	                    <!-- <input type="range" min="1" max="100" value="50" class="slider" id="myRange"> -->
	                </div>
	                <paper-button id="set_gripper_btn" on-tap="_setGripper" class="btn">Set Gripper Position</paper-button>

	                <div id="manual_btns">
	                    <paper-button id="open_gripper_btn" on-tap="_openGripper" class="btn">Open Gripper</paper-button>
	                    <paper-button id="close_gripper_btn" on-tap="_closeGripper" class="btn">Close Gripper</paper-button>
	                </div>
	            </div>

	            <paper-button id="emergency_stop_btn" on-tap="_emergencyStop" class="btn">EMERGENCY STOP</paper-button>

	        </div>
	        
	        <div id="tab">
	            <paper-button id="auto_btn" on-tap="_showAuto">Auto Mode</paper-button>
	            <paper-button id="manual_btn" on-tap="_showManual">Manual Mode</paper-button>  
	        </div>
	    </div>

        <!-- Style -->
        <style is="custom-style" include="iron-flex"></style>
	    <style>
			:host {
				display: block;
			}

			#interface {
			    text-align: center;
			    margin: 0;
			    font-family: sans-serif;
			}

			#main_interface {
				margin-bottom: 90px;
			}

			button, paper-button {
			    border-color: #dee2e4;
			    background-color: #dee2e4;
			}

			#header {
			    margin: auto;
			}

			#seperator {
			    background-color: #469bf8;
			    color: #fff;
			}

			#seperator h2 {
			    font-size: 0.8em;
			    font-weight: 200;
			    padding-top: 0.5em;
			    padding-bottom: 0.5em;
			}

			#auto, #manual {
				color: #435772;
				margin-bottom: 1.3em;
			}

			#manual {
			    display: none; 
			}

			#manual h4 {
				margin-bottom: 0.5em;
			}

			#tab {
			    background-color: #fff;
			    position: fixed;
			    bottom: 0;
			    left: 0;
			    width: 100%;
			    display: grid;
			    grid-template-columns: 1fr 1fr;
			    grid-template-rows: 1fr;
			}

			#tab paper-button {
			    font-size: 1em;
			    height: 3em;
			    margin: 0;
			}

			#auto_btn {
				/*border-right: 2px solid red;*/
				font-weight: 700;
			}

			#manual_btn {
				/*border-left: 2px solid red;*/
				font-weight: 300;
			}

			h3 {
			    font-size: 1.3em;
			}

			#feeding {
			    display: flex;
			    flex-direction: column;
			    height: 100%;
			}

			#feeding paper-button {
			    margin: auto;
			    width: 50%;
			    margin-bottom: 1em;
			    font-size: 1em;
			    height: 3em;
			    text-transform: capitalize;
			}

			#manual paper-button {
			    height: 2em;
			}

			#manual_btns {
			    margin-top: 1em;
			}

			#manual_btns paper-button {
			    text-transform: capitalize;
			}

			#emergency_stop_btn {
				height: 4em;
				background-color: #FFAB36;
			}

			#set_gripper_btn {
			    margin-top: 1em;
			}

			#info_btn {
				padding: 0;
				min-width: 0;
				height: auto !important;
			}

			#auto_info, #manual_info {
				background-color: #ccebff;
				z-index: 1;
				padding: 0.5em;
				margin-bottom: 0.5em;
			}

			.slidecontainer {
				width: 50%; 
				margin: auto;
			}
		</style>
	</template>

	<script>
		/**
		* @customElement
		* @polymer
		*/
		// the argument list we pass to the service
		var argsForService;
		// the last button user has pressed
		var btn;
		// the text in the last button the user has pressed
		var btn_original_text;
		// all the functional buttons
		var btns;

		class WebTeleopApp extends Polymer.Element {
			static get is() { return 'auxie-teleop-app'; }

			static get properties() {
				return {};     
			}        
		
			ready() {
				super.ready();
				this.status = "Auxie, your assisitve feeder";
				this.hostname = window.location.hostname;
				btns = this.shadowRoot.querySelectorAll(".btn");
			}

			_showAuto() {
				this.$.auto_btn.style.fontWeight = "700";
				this.$.auto.style.display = "block";
				this.$.manual_btn.style.fontWeight = "300";
				this.$.manual.style.display = "none";
			}

			_showManual() {
				this.$.auto_btn.style.fontWeight = "300";
				this.$.auto.style.display = "none";
				this.$.manual_btn.style.fontWeight = "700";
				this.$.manual.style.display = "block";
			}

			_showAutoInfo() {
				if (this.$.auto_info.style.display == "none") {
					this.$.auto_info.style.display = "block";
				} else {
					this.$.auto_info.style.display = "none";
				}
			}

			_showManualInfo() {
				if (this.$.manual_info.style.display == "none") {
					this.$.manual_info.style.display = "block";
				} else {
					this.$.manual_info.style.display = "none";
				}
			}

			// Integration with backend
			_handleConnection() {
				this._resetBtns(false);
				this.$.seperator.style.backgroundColor = "#469bf8";
				this.$.seperator.style.color = "white";
			}

			_handleClose() {
				this._resetBtns(true);
				this.$.seperator.style.backgroundColor = "#FFAB36";
				this.$.seperator.style.color = "black";
			}

			_handleError() {
				this._handleClose();
				this.status = 'Error connecting to the websocket server.';
			}

			_handleCommandSuccess() {
				this._handleConnection()
				this.status = "Auxie, your assisitve feeder";
				this._backToOriginal();
			}

			_handleCommandFail() {
				this.$.seperator.style.backgroundColor = "#FFAB36";
				this.$.seperator.style.color = "black";
				this.status = "Oops! Something is wrong!";
				this._backToOriginal();
			}

			_openGripper() {
				btn = this.$.open_gripper_btn;
				btn_original_text = this.$.open_gripper_btn.textContent;
				this.$.open_gripper_btn.textContent = "Opening gripper...";
				this.$.open_gripper_btn.disabled = true;
				this.status = "Opening gripper...";
				this.$.commandService.call({command: "open"});
			}

			_closeGripper() {
				btn = this.$.close_gripper_btn;
				btn_original_text = this.$.close_gripper_btn.textContent;
				this.$.close_gripper_btn.textContent = "Closing gripper...";
				this.$.close_gripper_btn.disabled = true;
				this.status = "Closing gripper...";
				this.$.commandService.call({command: "close"});
			}

			_setGripper() {
				btn = this.$.set_gripper_btn;
				btn_original_text = this.$.set_gripper_btn.textContent;
				this.$.set_gripper_btn.textContent = "SETTING";
				this.$.set_gripper_btn.disabled = true;
				this.status = "Setting gripper position...";
				argsForService = [this.desiredGripperX.toString(), this.desiredGripperY.toString(), this.desiredGripperZ.toString()];
				this.$.commandService.call({command: "move", args: argsForService});
			}

			_grabFork() {
				btn = this.$.grab_fork_btn;
				btn_original_text = this.$.grab_fork_btn.textContent;
				argsForService = ["fork"];
				this.$.grab_fork_btn.textContent = "Grabbing fork...";
				this.$.grab_fork_btn.disabled = true;
				this.$.commandService.call({command: "run", args: argsForService});
			}

			_grabSpoon() {
				btn = this.$.grab_spoon_btn;
				btn_original_text = this.$.grab_spoon_btn.textContent;
				argsForService = ["spoon"];
				this.$.grab_spoon_btn.textContent = "Grabbing spoon...";
				this.$.grab_spoon_btn.disabled = true;
				this.$.commandService.call({command: "run", args: argsForService});
			}

			_feed() {
				btn = this.$.feed_btn;
				btn_original_text = this.$.feed_btn.textContent;
				argsForService = ["feed"];
				this.$.feed_btn.textContent = "Feeding...";
				this.$.feed_btn.disabled = true;
				this.$.commandService.call({command: "run", args: argsForService});
			}

			_emergencyStop() {
				btn = this.$.emergency_stop_btn;
				btn_original_text = this.$.emergency_stop_btn.textContent;
				// argsForService = ["feed"];
				this.$.emergency_stop_btn.textContent = "STOPPING AUXIE";
				this.$.emergency_stop_btn.disabled = true;
				this.$.emergency_stop_btn.style.color = "white";
				// this.$.commandService.call({command: "run", args: argsForService});
			}

			_backToOriginal() {
				// change the button property back to its original ones
				btn.textContent = btn_original_text;
				btn.disabled = false;
				if (btn == this.$.emergency_stop_btn) {
					btn.style.color = "black";
				}
			}

			_resetBtns(isDisabled) {
				for (var i = 0; i < btns.length; i++) { 
					btns[i].disabled = isDisabled;
				}
			}
		}

		window.customElements.define(WebTeleopApp.is, WebTeleopApp);
	</script>


</dom-module>